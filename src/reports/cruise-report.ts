import { CruiseStats, Ticket, Language, Category } from '../types';

export interface CruiseReportOptions {
  language: Language;
  since?: number;
  until?: number;
  useLLM?: boolean;
  llmClient?: any;
}

const reportTitles: Record<Language, string> = {
  'zh-CN': 'å®¢è¯‰å·¡èˆªæŠ¥å‘Š',
  'zh-TW': 'å®¢è¨´å·¡èˆªå ±å‘Š',
  'en': 'Ticket Cruise Report',
  'ja': 'ãƒã‚±ãƒƒãƒˆå·¡èˆªãƒ¬ãƒãƒ¼ãƒˆ',
  'ko': 'í‹°ì¼“ ìˆœíšŒ ë³´ê³ ì„œ',
  'es': 'Informe de Crucero de Tickets',
  'unknown': 'Ticket Cruise Report'
};

const execSummaryLabels: Record<Language, { total: string; highPriority: string }> = {
  'zh-CN': { total: 'ç»Ÿè®¡å®¢è¯‰', highPriority: 'é«˜ä¼˜å…ˆçº§' },
  'zh-TW': { total: 'çµ±è¨ˆå®¢è¨´', highPriority: 'é«˜å„ªå…ˆç´š' },
  'en': { total: 'Total Tickets', highPriority: 'High Priority' },
  'ja': { total: 'ç·ãƒã‚±ãƒƒãƒˆæ•°', highPriority: 'é«˜å„ªå…ˆåº¦' },
  'ko': { total: 'ì´ í‹°ì¼“', highPriority: 'ë†’ì€ ìš°ì„ ìˆœìœ„' },
  'es': { total: 'Total de Tickets', highPriority: 'Alta Prioridad' },
  'unknown': { total: 'Total Tickets', highPriority: 'High Priority' }
};

const sectionLabels: Record<Language, { langDist: string; catStats: string }> = {
  'zh-CN': { langDist: 'è¯­è¨€åˆ†å¸ƒ', catStats: 'åˆ†ç±»ç»Ÿè®¡' },
  'zh-TW': { langDist: 'èªè¨€åˆ†ä½ˆ', catStats: 'åˆ†é¡çµ±è¨ˆ' },
  'en': { langDist: 'Language Distribution', catStats: 'Category Statistics' },
  'ja': { langDist: 'è¨€èªåˆ†å¸ƒ', catStats: 'ã‚«ãƒ†ã‚´ãƒªçµ±è¨ˆ' },
  'ko': { langDist: 'ì–¸ì–´ ë¶„í¬', catStats: 'ì¹´í…Œê³ ë¦¬ í†µê³„' },
  'es': { langDist: 'DistribuciÃ³n de Idiomas', catStats: 'EstadÃ­sticas de CategorÃ­as' },
  'unknown': { langDist: 'Language Distribution', catStats: 'Category Statistics' }
};

const tableHeaders: Record<Language, { lang: string; count: string; pct: string; category: string }> = {
  'zh-CN': { lang: 'è¯­è¨€', count: 'æ•°é‡', pct: 'å æ¯”', category: 'ç±»åˆ«' },
  'zh-TW': { lang: 'èªè¨€', count: 'æ•¸é‡', pct: 'ä½”æ¯”', category: 'é¡åˆ¥' },
  'en': { lang: 'Language', count: 'Count', pct: 'Percentage', category: 'Category' },
  'ja': { lang: 'è¨€èª', count: 'ä»¶æ•°', pct: 'å‰²åˆ', category: 'ã‚«ãƒ†ã‚´ãƒª' },
  'ko': { lang: 'ì–¸ì–´', count: 'ìˆ˜ëŸ‰', pct: 'ë¹„ìœ¨', category: 'ì¹´í…Œê³ ë¦¬' },
  'es': { lang: 'Idioma', count: 'Cantidad', pct: 'Porcentaje', category: 'CategorÃ­a' },
  'unknown': { lang: 'Language', count: 'Count', pct: 'Percentage', category: 'Category' }
};

export function generateCruiseReport(
  tickets: Ticket[],
  stats: CruiseStats,
  options: CruiseReportOptions
): string {
  const { language } = options;
  const labels = execSummaryLabels[language];
  const sections = sectionLabels[language];
  const headers = tableHeaders[language];
  
  const lines: string[] = [];
  lines.push(`# ${reportTitles[language]} â€” ${formatDateCN(Date.now())}`);
  lines.push('');
  lines.push(`## ${language === 'en' ? 'Executive Summary' : sections.langDist.replace('è¯­è¨€åˆ†å¸ƒ', 'æ‰§è¡Œæ‘˜è¦').replace('èªè¨€åˆ†ä½ˆ', 'åŸ·è¡Œæ‘˜è¦')}`);
  lines.push(`- ${labels.total}: ${stats.total} ${language === 'zh-CN' || language === 'zh-TW' ? 'æ¡' : ''}`);
  lines.push(`- ${labels.highPriority}: ${stats.highPriority} ${language === 'zh-CN' || language === 'zh-TW' ? 'æ¡' : ''}`);
  lines.push('');
  
  // Language distribution section title
  lines.push(`## ${sections.langDist}`);
  lines.push(`| ${headers.lang} | ${headers.count} | ${headers.pct} |`);
  lines.push('|------|------|------|');
  for (const [lang, count] of Object.entries(stats.languages)) {
    const percentage = stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : '0.0';
    lines.push(`| ${getLanguageName(lang, language)} | ${count} | ${percentage}% |`);
  }
  lines.push('');
  
  // Category statistics section
  lines.push(`## ${sections.catStats}`);
  lines.push(`| ${headers.category} | ${headers.count} | ${headers.pct} |`);
  lines.push('|------|------|------|');
  for (const [cat, count] of Object.entries(stats.categories)) {
    const percentage = stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : '0.0';
    const icon = getCategoryIcon(cat as Category);
    lines.push(`| ${icon} ${getCategoryName(cat as Category, language)} | ${count} | ${percentage}% |`);
  }
  lines.push('');
  
  // é¡µè„š
  lines.push('---');
  lines.push(`Generated by Community Manager Agent Spine v0.5.0`);
  
  return lines.join('\n');
}

export function calculateCruiseStats(tickets: Ticket[]): CruiseStats {
  const stats: CruiseStats = {
    total: tickets.length,
    categories: {} as Record<Category, number>,
    languages: {} as Record<Language, number>,
    highPriority: 0
  };
  
  for (const ticket of tickets) {
    stats.categories[ticket.category] = (stats.categories[ticket.category] || 0) + 1;
    if (ticket.detected_language) {
      stats.languages[ticket.detected_language] = (stats.languages[ticket.detected_language] || 0) + 1;
    }
    if (ticket.severity === 'high' || ticket.severity === 'critical') {
      stats.highPriority++;
    }
  }
  
  return stats;
}

function formatDateCN(timestamp: number): string {
  const date = new Date(timestamp);
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
}

function getLanguageName(lang: string, displayLanguage: Language): string {
  const names: Record<string, Record<string, string>> = {
    'zh-CN': { 'zh-CN': 'ç®€ä½“ä¸­æ–‡', 'zh-TW': 'ç¹ä½“ä¸­æ–‡', 'en': 'è‹±æ–‡', 'ja': 'æ—¥æ–‡', 'ko': 'éŸ©æ–‡', 'es': 'è¥¿ç­ç‰™æ–‡' },
    'en': { 'zh-CN': 'Simplified Chinese', 'zh-TW': 'Traditional Chinese', 'en': 'English', 'ja': 'Japanese', 'ko': 'Korean', 'es': 'Spanish' }
  };
  return names[displayLanguage]?.[lang] || lang;
}

function getCategoryIcon(category: Category): string {
  const icons: Record<Category, string> = {
    'payment': 'ğŸ’°',
    'refund': 'ğŸ”„',
    'bug': 'ğŸ›',
    'ban_appeal': 'ğŸ”’',
    'abuse': 'âš ï¸',
    'general': 'ğŸ“'
  };
  return icons[category] || 'â“';
}

function getCategoryName(category: Category, language: Language): string {
  const names: Partial<Record<Language, Record<Category, string>>> = {
    'zh-CN': {
      'payment': 'å……å€¼/æ”¯ä»˜',
      'refund': 'é€€æ¬¾',
      'bug': 'æ¸¸æˆBug',
      'ban_appeal': 'å°å·ç”³è¯‰',
      'abuse': 'ä¸¾æŠ¥/ä½œå¼Š',
      'general': 'å…¶ä»–'
    },
    'en': {
      'payment': 'Payment',
      'refund': 'Refund',
      'bug': 'Bug',
      'ban_appeal': 'Ban Appeal',
      'abuse': 'Abuse',
      'general': 'General'
    }
  };
  return names[language]?.[category] || category;
}
